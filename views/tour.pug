extends base
include _reviewCard

block append head
  script(src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js')
  link(href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet')
  script.
    window.MAPBOX_TOKEN = '#{mapboxToken}';

mixin overviewBox(label, text, icon)
  .overview-box__detail
    i(class=`fas fa-${icon} overview-box__icon`)
    .overview-box__content
      span.overview-box__label= label
      span.overview-box__text= text

block content
  section.tour-header
    .tour-header__image
      img.tour-header__img(src=`/img/tours/${tour.imageCover}`, alt=`${tour.name}`)
      .tour-header__overlay
        .container
          h1.tour-header__title= tour.name
          .tour-header__badges
            span(class=`badge badge--large badge--${tour.difficulty}`)= tour.difficulty
            span.badge.badge--large= `${tour.duration} days`

  .container
    .tour-content
      .tour-details
        .tour-section
          h2.tour-section__title Overview
          p.tour-description= tour.description

        .tour-section
          h2.tour-section__title Quick Facts
          .overview-box
            .overview-box__group
              +overviewBox('Next Date', tour.startDates[0].toLocaleString('en-us', {month: 'long', year: 'numeric'}), 'calendar')
              +overviewBox('Difficulty', tour.difficulty, 'trending-up')
              +overviewBox('Participants', `${tour.maxGroupSize} people`, 'users')
              +overviewBox('Rating', `${tour.ratingsAverage} / 5`, 'star')

        .tour-section
          h2.tour-section__title Your Tour Guides
          .guides
            each guide in tour.guides
              .guide-card
                img.guide-card__img(src=`/img/users/${guide.photo}`, alt=`${guide.name}`)
                .guide-card__info
                  h3.guide-card__name= guide.name
                  p.guide-card__role= guide.role === 'lead-guide' ? 'Lead Guide' : 'Tour Guide'

        .tour-section
          h2.tour-section__title Gallery
          .gallery
            each img, i in tour.images
              .gallery__item
                img.gallery__img(src=`/img/tours/${img}`, alt=`Tour gallery ${i + 1}`)

        .tour-section
          h2.tour-section__title Map
          #map.tour-map(data-locations=`${JSON.stringify(tour.locations)}`)

        .tour-section
          h2.tour-section__title Reviews
          .reviews
            each review in tour.reviews
              +reviewCard(review)
          
          // Review submission form
          if user && user !== null
            .reviews__form
              h3.submit-review__title Add Your Review
              form.form.form--review#review-form(data-tour-id=`${tour.id}`)
                .form__group
                  label.form__label(for='review-rating') Your Rating
                  .review-rating
                    .stars
                      - for (let i = 1; i <= 5; i++)
                        svg.star-rating__star(data-rating=`${i}`)
                          use(xlink:href='/img/icons.svg#icon-star')
                    input#review-rating(type='hidden', name='rating', value='0', required)
                
                .form__group
                  label.form__label(for='review-text') Your Review
                  textarea#review-text.form__textarea(name='review', placeholder='Share your experience...', required)
                
                button.btn.btn--primary.btn--small#submit-review Submit Review
          else
            p.reviews__login-message
              a(href='/login') Log in 
              | to submit a review

      .tour-booking
        .booking-card
          .booking-card__header
            h2.booking-card__title Book This Tour
            .booking-card__price
              span.booking-card__price-value= `$${tour.price}`
              span.booking-card__price-text per person
          
          form.form.form--booking
            .form__group
              label.form__label(for='startDate') Start Date
              input#startDate.form__input(type='date', name='startDate', required)
            .form__group
              label.form__label(for='endDate') End Date
              input#endDate.form__input(type='date', name='endDate', required)
            .form__group
              if user && user !== null
                button.btn.btn--primary.btn--block#bookTour(data-tour-id=`${tour.id}`) Book Now
              else
                a.btn.btn--primary.btn--block(href='/login') Log in to Book

  section.section-cta
    .cta
      .container
        .cta__content
          h2.cta__title What are you waiting for?
          p.cta__text= `${tour.duration} days. 1 adventure. Infinite memories. Make it yours today!`
          
          if user && user !== null
            button.btn.btn--primary.btn--large#book-tour(data-tour-id=`${tour.id}`) Book Tour Now
          else
            a.btn.btn--primary.btn--large(href='/login') Log in to Book Tour

  .container
    .tour-navigation
      a.btn.btn--back(href='/')
        i.fas.fa-arrow-left
        | Back to Tours
      button.btn.btn--back(onclick='window.scrollTo({top: 0, behavior: "smooth"});')
        i.fas.fa-arrow-up
        | Back to Top

  script(src='/js/map-test.js')
  script(src='/js/map-debug.js')